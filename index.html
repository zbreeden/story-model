<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FourTwenty Analytics ‚Äî The Story</title>
  <meta name="description" content="A lightweight, file-based narrative engine (scenes + choices) with analytics hooks." />
  <meta name="color-scheme" content="light dark" />

  <!-- Google Tag Manager (GTM) -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WVC4SNLB'); /* ‚Üê replace if needed */
  </script>
  <!-- End GTM -->

  <link rel="stylesheet" href="styles/site.css" />
</head>
<body>
  <!-- GTM (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WVC4SNLB" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <header class="wrap header">
    <div class="brand">
      <a href="https://zbreeden.github.io/FourTwentyAnalytics/" class="crumb">‚üµ Constellation</a>
      <h1>üìñ The Story</h1>
      <p class="tagline">Narrative lives here. The Player handles sims; The Story handles scenes & choices.</p>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card" id="player">
      <h2>Scene</h2>
      <div id="scene-text" class="prose"></div>

      <!-- NEW: free-input console -->
      <div class="console">
        <form id="freeform" autocomplete="off" aria-labelledby="console-label">
          <label id="console-label" class="sr-only">Speak to Chloe</label>
          <input id="utterance" type="text" placeholder="Type a thought‚Ä¶ e.g., 'Why spirals?'" aria-label="Thought input" />
          <button type="submit" title="Send">Send</button>
          <select id="tone" title="Guidance tone">
            <option value="gentle" selected>Gentle</option>
            <option value="snark">Snark</option>
          </select>
        </form>
        <div id="response" class="response" aria-live="polite"></div>
      </div>

      <div id="choices" class="choices"></div>
      <div class="toolbar">
        <button id="back-btn" title="Go to previous scene">‚óÄ Back</button>
        <button id="restart-btn" title="Restart story">‚ü≤ Restart</button>
      </div>
    </section>

    <section class="card" id="readme-card">
      <h2>Repo Docs</h2>
      <p><a id="open-readme" href="README.md" target="_blank" rel="noopener">Open README on GitHub</a></p>
      <article id="readme-panel" class="prose muted"><em>Loading README‚Ä¶</em></article>
    </section>
  </main>

  <footer class="wrap footer">
    <small>¬© FourTwenty Analytics ¬∑ Built as a file-based engine (no build). ¬∑ <a href="#" id="emit-debug">Emit debug event</a></small>
  </footer>

  <!-- App scripts -->
  <script type="module" src="scripts/story.js"></script>
  <script>
    // Lightweight README loader (raw file ‚Üí plain text). Keeps dependencies zero.
    (function(){
      const panel = document.getElementById('readme-panel');
      const link  = document.getElementById('open-readme');
      if (!panel || !link) return;

      const raw = (function(){
        try {
          const url = new URL(window.location.href);
          const base = url.origin + url.pathname.replace(/\/[^/]*$/, '/');
          return base + 'README.md';
        } catch(e) { return 'README.md'; }
      })();

      fetch(raw).then(r=>r.text()).then(txt=>{
        const html = txt
          .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
          .replace(/^# (.*)$/gm, '<h1>$1</h1>')
          .replace(/^## (.*)$/gm, '<h2>$1</h2>')
          .replace(/^### (.*)$/gm, '<h3>$1</h3>')
          .replace(/^\- (.*)$/gm, '<li>$1</li>')
          .replace(/\n<li>/g, '<ul><li>').replace(/<\/li>\n(?!<li>)/g,'</li></ul>')
          .replace(/\n\n/g, '<br/><br/>');
        panel.innerHTML = html;
      }).catch(()=>{ panel.innerHTML = '<em>Could not load README in-page. Use the link above.</em>'; });
    })();
  </script>
</body>
</html>
